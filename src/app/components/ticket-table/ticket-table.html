<mat-card class="ticket-table-card">
  <mat-card-content>
    <!-- Indicateur de chargement -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Chargement des tickets...</p>
    </div>

    <!-- Message d'erreur -->
    <div *ngIf="error && !isLoading" class="error-container">
      <mat-icon class="error-icon">error</mat-icon>
      <p>{{error}}</p>
      <button mat-raised-button color="primary" (click)="loadTickets()">Réessayer</button>
    </div>

    <!-- Tableau des tickets -->
    <div *ngIf="!isLoading && !error" class="table-container">
      <table mat-table [dataSource]="tickets" class="tickets-table">

        <!-- ID Column -->
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef class="id-column">ID</th>
          <td mat-cell *matCellDef="let ticket" class="id-column">#{{ticket.id}}</td>
        </ng-container>

        <!-- Title Column -->
        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Titre</th>
          <td mat-cell *matCellDef="let ticket" class="title-cell">
            <div class="ticket-title">{{ticket.title}}</div>
            <div class="ticket-description">{{ticket.description | slice:0:80}}{{ticket.description.length > 80 ? '...' : ''}}</div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Statut</th>
          <td mat-cell *matCellDef="let ticket">
            <mat-chip [color]="getStatusColor(ticket.status)" 
                     selected 
                     class="status-badge clickable"
                     (click)="$event.stopPropagation(); toggleTicketStatus(ticket)"
                     matTooltip="Cliquer pour changer le statut"
                     [attr.aria-label]="'Changer le statut du ticket. Statut actuel: ' + getStatusText(ticket.status)">
              {{getStatusText(ticket.status)}}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Created By Column -->
        <ng-container matColumnDef="createdBy">
          <th mat-header-cell *matHeaderCellDef>Créé par</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="creator-info">
              <div class="creator-name">{{ticket.createdBy.prenom}} {{ticket.createdBy.nom}}</div>
              <div class="creator-email">{{ticket.createdBy.email}}</div>
            </div>
          </td>
        </ng-container>

        <!-- Assigned To Column -->
        <ng-container matColumnDef="assignedTo">
          <th mat-header-cell *matHeaderCellDef>Assigné à</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="assigned-info" *ngIf="ticket.assignedTo; else notAssigned">
              <div class="assigned-name">{{ticket.assignedTo.prenom}} {{ticket.assignedTo.nom}}</div>
              <div class="assigned-email">{{ticket.assignedTo.email}}</div>
            </div>
            <ng-template #notAssigned>
              <div class="not-assigned">
                <mat-icon class="not-assigned-icon">person_off</mat-icon>
                <span>Non assigné</span>
              </div>
            </ng-template>
          </td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Date de création</th>
          <td mat-cell *matCellDef="let ticket">
            {{formatDate(ticket.createdAt)}}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-column">Actions</th>
          <td mat-cell *matCellDef="let ticket" class="actions-column">
            <button mat-icon-button 
                    matTooltip="Voir les détails" 
                    (click)="$event.stopPropagation(); viewTicket(ticket)"
                    color="primary">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button 
                    matTooltip="Éditer le ticket" 
                    (click)="$event.stopPropagation(); editTicket(ticket)"
                    color="accent">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
            class="ticket-row"
            tabindex="0"
            [attr.aria-label]="'Voir le ticket ' + row.id"
            (click)="viewTicket(row)"
            (keydown.enter)="viewTicket(row)"
            (keydown.space)="$event.preventDefault(); viewTicket(row)">
        </tr>
      </table>

      <!-- Message si aucun ticket -->
      <div *ngIf="tickets.length === 0 && !isLoading && !error" class="no-tickets">
        <mat-icon class="no-tickets-icon">inbox</mat-icon>
        <p>Aucun ticket trouvé</p>
      </div>
    </div>
  </mat-card-content>
</mat-card>
